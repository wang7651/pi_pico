# Lesson 7 - Raspberry Pi Pico W WiFi é€£ç·šæ¨¡çµ„

æœ¬èª²ç¨‹æä¾›ä¸€å€‹ç°¡æ½”æ˜“ç”¨çš„ WiFi é€£ç·šæ¨¡çµ„ï¼Œé©ç”¨æ–¼ **Raspberry Pi Pico W** æ­é… **MicroPython** ç’°å¢ƒã€‚

---

## ğŸ“ æª”æ¡ˆçµæ§‹

```
lesson7/
â”œâ”€â”€ wifi_connect.py   # WiFi é€£ç·šåŠŸèƒ½æ¨¡çµ„
â”œâ”€â”€ main.py           # ä¸»ç¨‹å¼ï¼ˆæ¸¬è©¦ç¯„ä¾‹ï¼‰
â””â”€â”€ README.md         # èªªæ˜æ–‡ä»¶
```

---

## ğŸ“ ç¨‹å¼é‚è¼¯èªªæ˜

### 1. `wifi_connect.py` - WiFi é€£ç·šæ¨¡çµ„

é€™å€‹æ¨¡çµ„å°è£äº†æ‰€æœ‰ WiFi ç›¸é—œçš„æ“ä½œï¼Œæä¾›ä»¥ä¸‹åŠŸèƒ½ï¼š

#### å…¨åŸŸè®Šæ•¸

```python
WIFI_SSID = "xxxx"        # WiFi åç¨±
WIFI_PASSWORD = "xxx"     # WiFi å¯†ç¢¼
```

é€™æ˜¯é è¨­çš„ WiFi é€£ç·šè³‡è¨Šï¼Œä½¿ç”¨è€…éœ€è¦æ‰‹å‹•ä¿®æ”¹æˆè‡ªå·±çš„ WiFi è¨­å®šã€‚

---

#### å‡½å¼èªªæ˜

| å‡½å¼åç¨± | åŠŸèƒ½èªªæ˜ | å›å‚³å€¼ |
|----------|----------|--------|
| `connect()` | é€£ç·šåˆ° WiFi | WLAN ç‰©ä»¶ |
| `disconnect()` | æ–·é–‹ WiFi é€£ç·š | ç„¡ |
| `is_connected()` | æª¢æŸ¥æ˜¯å¦å·²é€£ç·š | `True` / `False` |
| `get_ip()` | å–å¾—ç›®å‰çš„ IP ä½å€ | IP å­—ä¸²æˆ– `None` |
| `test_internet()` | æ¸¬è©¦å¤–éƒ¨ç¶²è·¯æ˜¯å¦å¯ç”¨ | `True` / `False` |

---

#### `connect(ssid, password, retry)` é€£ç·šå‡½å¼

**ç¨‹å¼é‚è¼¯æµç¨‹ï¼š**

```
é–‹å§‹
  â”‚
  â–¼
æª¢æŸ¥æ˜¯å¦å·²ç¶“é€£ç·šï¼Ÿ â”€â”€æ˜¯â”€â”€â–º ç›´æ¥å›å‚³ WLAN ç‰©ä»¶
  â”‚
  å¦
  â–¼
å•Ÿå‹• WLAN ä»‹é¢ï¼ˆwlan.active(True)ï¼‰
  â”‚
  â–¼
å‘¼å« wlan.connect(ssid, password)
  â”‚
  â–¼
è¿´åœˆç­‰å¾…é€£ç·šï¼ˆæœ€å¤š retry æ¬¡ï¼Œé è¨­ 20 æ¬¡ï¼‰
  â”‚
  â”œâ”€â”€ é€£ç·šæˆåŠŸ â”€â”€â–º å°å‡º IP è³‡è¨Šï¼Œå›å‚³ WLAN ç‰©ä»¶
  â”‚
  â””â”€â”€ ç­‰å¾… 1 ç§’å¾Œå†æ¬¡æª¢æŸ¥
  â”‚
  â–¼
è¶…éé‡è©¦æ¬¡æ•¸ â”€â”€â–º æ‹‹å‡º RuntimeError ä¾‹å¤–
```

**åƒæ•¸èªªæ˜ï¼š**
- `ssid`ï¼šWiFi åç¨±ï¼ˆé è¨­ä½¿ç”¨å…¨åŸŸè®Šæ•¸ `WIFI_SSID`ï¼‰
- `password`ï¼šWiFi å¯†ç¢¼ï¼ˆé è¨­ä½¿ç”¨å…¨åŸŸè®Šæ•¸ `WIFI_PASSWORD`ï¼‰
- `retry`ï¼šé‡è©¦æ¬¡æ•¸ï¼ˆé è¨­ 20 æ¬¡ï¼Œæ¯æ¬¡é–“éš” 1 ç§’ï¼‰

---

#### `disconnect()` æ–·ç·šå‡½å¼

**ç¨‹å¼é‚è¼¯ï¼š**
1. å–å¾— WLAN ç‰©ä»¶
2. å¦‚æœç›®å‰å·²é€£ç·šï¼Œå‰‡å‘¼å« `wlan.disconnect()` ä¸¦é—œé–‰ WLAN ä»‹é¢
3. å¦‚æœæœªé€£ç·šï¼Œå‰‡å°å‡ºæç¤ºè¨Šæ¯

---

#### `is_connected()` æª¢æŸ¥é€£ç·šç‹€æ…‹

**ç¨‹å¼é‚è¼¯ï¼š**
- ç›´æ¥å›å‚³ `wlan.isconnected()` çš„çµæœï¼ˆ`True` æˆ– `False`ï¼‰

---

#### `get_ip()` å–å¾— IP ä½å€

**ç¨‹å¼é‚è¼¯ï¼š**
1. æª¢æŸ¥æ˜¯å¦å·²é€£ç·š
2. å¦‚æœå·²é€£ç·šï¼Œå›å‚³ IP ä½å€ï¼ˆ`wlan.ifconfig()[0]`ï¼‰
3. å¦‚æœæœªé€£ç·šï¼Œå›å‚³ `None`

---

#### `test_internet(host, port, timeout)` æ¸¬è©¦å¤–éƒ¨ç¶²è·¯

**ç¨‹å¼é‚è¼¯ï¼š**
1. ä½¿ç”¨ `socket.getaddrinfo()` è§£æç›®æ¨™ä¸»æ©Ÿ
2. å»ºç«‹ socket é€£ç·šä¸¦è¨­å®šè¶…æ™‚æ™‚é–“
3. å˜—è©¦é€£ç·šåˆ°ç›®æ¨™ï¼ˆé è¨­ç‚º Google DNS 8.8.8.8:53ï¼‰
4. é€£ç·šæˆåŠŸå›å‚³ `True`ï¼Œå¤±æ•—å›å‚³ `False`

**åƒæ•¸èªªæ˜ï¼š**
- `host`ï¼šæ¸¬è©¦çš„ä¸»æ©Ÿä½å€ï¼ˆé è¨­ `8.8.8.8`ï¼‰
- `port`ï¼šæ¸¬è©¦çš„é€£æ¥åŸ ï¼ˆé è¨­ `53`ï¼‰
- `timeout`ï¼šè¶…æ™‚ç§’æ•¸ï¼ˆé è¨­ `3` ç§’ï¼‰

---

### 2. `main.py` - ä¸»ç¨‹å¼

é€™æ˜¯ä¸€å€‹ç°¡å–®çš„æ¸¬è©¦ç¨‹å¼ï¼Œç¤ºç¯„å¦‚ä½•ä½¿ç”¨ `wifi_connect` æ¨¡çµ„ï¼š

```python
import wifi_connect

# æ­¥é©Ÿ 1ï¼šå˜—è©¦é€£ç·š WiFi
wifi_connect.connect()

# æ­¥é©Ÿ 2ï¼šé¡¯ç¤º IP ä½å€
print("IP:", wifi_connect.get_ip())

# æ­¥é©Ÿ 3ï¼šæ¸¬è©¦å¤–éƒ¨ç¶²è·¯
if wifi_connect.test_internet():
    print("å¤–éƒ¨ç¶²è·¯ OK")
else:
    print("å¤–éƒ¨ç¶²è·¯ç„¡æ³•é€£ç·š")
```

**åŸ·è¡Œæµç¨‹ï¼š**

```
1. åŒ¯å…¥ wifi_connect æ¨¡çµ„
       â”‚
       â–¼
2. å‘¼å« connect() é€£ç·š WiFi
       â”‚
       â–¼
3. å–å¾—ä¸¦é¡¯ç¤º IP ä½å€
       â”‚
       â–¼
4. æ¸¬è©¦å¤–éƒ¨ç¶²è·¯é€£ç·š
       â”‚
       â”œâ”€â”€ æˆåŠŸ â”€â”€â–º å°å‡º "å¤–éƒ¨ç¶²è·¯ OK"
       â”‚
       â””â”€â”€ å¤±æ•— â”€â”€â–º å°å‡º "å¤–éƒ¨ç¶²è·¯ç„¡æ³•é€£ç·š"
```

---

## âš™ï¸ å¦‚ä½•ä¿®æ”¹ WiFi è¨­å®š

### æ–¹æ³•ä¸€ï¼šç›´æ¥ä¿®æ”¹å…¨åŸŸè®Šæ•¸ï¼ˆæ¨è–¦ï¼‰

é–‹å•Ÿ `wifi_connect.py`ï¼Œæ‰¾åˆ°ç¬¬ 12-13 è¡Œï¼š

```python
# ä¿®æ”¹å‰
WIFI_SSID = "xxxx"
WIFI_PASSWORD = "xxx"

# ä¿®æ”¹å¾Œï¼ˆç¯„ä¾‹ï¼‰
WIFI_SSID = "MyHomeWiFi"
WIFI_PASSWORD = "my_secret_password_123"
```

> âš ï¸ **æ³¨æ„äº‹é …ï¼š**
> - SSID å’Œå¯†ç¢¼éƒ½è¦ç”¨**é›™å¼•è™Ÿ**åŒ…èµ·ä¾†
> - å¯†ç¢¼è«‹å€åˆ†**å¤§å°å¯«**
> - ä¸è¦æœ‰å¤šé¤˜çš„ç©ºæ ¼

---

### æ–¹æ³•äºŒï¼šåœ¨ main.py ä¸­æŒ‡å®šåƒæ•¸

å¦‚æœä¸æƒ³ä¿®æ”¹ `wifi_connect.py`ï¼Œå¯ä»¥åœ¨å‘¼å« `connect()` æ™‚ç›´æ¥å‚³å…¥åƒæ•¸ï¼š

```python
import wifi_connect

# ç›´æ¥å‚³å…¥ SSID å’Œå¯†ç¢¼
wifi_connect.connect(ssid="MyHomeWiFi", password="my_secret_password_123")

print("IP:", wifi_connect.get_ip())
```

é€™ç¨®æ–¹å¼çš„å¥½è™•æ˜¯ä¸éœ€è¦ä¿®æ”¹åŸå§‹æ¨¡çµ„æª”æ¡ˆã€‚

---

### æ–¹æ³•ä¸‰ï¼šå»ºç«‹ç¨ç«‹çš„è¨­å®šæª”ï¼ˆé€²éšï¼‰

å»ºç«‹ä¸€å€‹ `secrets.py` æª”æ¡ˆä¾†å­˜æ”¾æ•æ„Ÿè³‡è¨Šï¼š

```python
# secrets.py
WIFI_SSID = "MyHomeWiFi"
WIFI_PASSWORD = "my_secret_password_123"
```

ç„¶å¾Œåœ¨ `main.py` ä¸­ä½¿ç”¨ï¼š

```python
import wifi_connect
import secrets

wifi_connect.connect(ssid=secrets.WIFI_SSID, password=secrets.WIFI_PASSWORD)
```

> ğŸ’¡ **æç¤ºï¼š** ä½¿ç”¨ç¨ç«‹è¨­å®šæª”çš„å¥½è™•æ˜¯å¯ä»¥å°‡ `secrets.py` åŠ å…¥ `.gitignore`ï¼Œé¿å…å°‡å¯†ç¢¼ä¸Šå‚³åˆ°ç‰ˆæœ¬æ§åˆ¶ç³»çµ±ã€‚

---

## ğŸš€ å¿«é€Ÿé–‹å§‹

1. **ä¿®æ”¹ WiFi è¨­å®š**ï¼ˆåƒè€ƒä¸Šæ–¹èªªæ˜ï¼‰

2. **ä¸Šå‚³æª”æ¡ˆåˆ° Pico W**
   - `wifi_connect.py`
   - `main.py`

3. **åŸ·è¡Œç¨‹å¼**
   - åœ¨ Thonny æˆ–å…¶ä»– MicroPython IDE ä¸­åŸ·è¡Œ `main.py`

4. **è§€å¯Ÿè¼¸å‡º**
   ```
   å•Ÿå‹• WLAN...
   æº–å‚™é€£ç·š SSIDï¼šMyHomeWiFi
   é€£ç·šä¸­... (1/20)
   é€£ç·šä¸­... (2/20)
   WiFi é€£ç·šæˆåŠŸï¼
   IP è³‡è¨Šï¼š ('192.168.1.100', '255.255.255.0', '192.168.1.1', '8.8.8.8')
   IP: 192.168.1.100
   å¤–éƒ¨ç¶²è·¯ OK
   ```

---

## â“ å¸¸è¦‹å•é¡Œ

### Q1ï¼šé€£ç·šå¤±æ•—æ€éº¼è¾¦ï¼Ÿ

- ç¢ºèª SSID å’Œå¯†ç¢¼æ˜¯å¦æ­£ç¢º
- ç¢ºèª Pico W æ˜¯å¦åœ¨ WiFi è¨Šè™Ÿç¯„åœå…§
- å˜—è©¦å¢åŠ  `retry` åƒæ•¸ï¼š`wifi_connect.connect(retry=30)`

### Q2ï¼šå¦‚ä½•é€£ç·šåˆ° 5GHz WiFiï¼Ÿ

Raspberry Pi Pico W **åªæ”¯æ´ 2.4GHz WiFi**ï¼Œä¸æ”¯æ´ 5GHz é »æ®µã€‚

### Q3ï¼šå¤–éƒ¨ç¶²è·¯æ¸¬è©¦å¤±æ•—ä½† WiFi å·²é€£ç·šï¼Ÿ

å¯èƒ½æ˜¯è·¯ç”±å™¨çš„ç¶²è·¯è¨­å®šå•é¡Œï¼Œè«‹ç¢ºèªè·¯ç”±å™¨å¯ä»¥æ­£å¸¸é€£æ¥ç¶²éš›ç¶²è·¯ã€‚

---

## ğŸ“š åƒè€ƒè³‡æº

- [MicroPython network æ¨¡çµ„æ–‡ä»¶](https://docs.micropython.org/en/latest/library/network.html)
- [Raspberry Pi Pico W å®˜æ–¹æ–‡ä»¶](https://www.raspberrypi.com/documentation/microcontrollers/raspberry-pi-pico.html)

## ğŸ”§ éŒ¯èª¤åˆ†æï¼š`ECONNRESET` (éŒ¯èª¤ç¢¼ 104)

é€™å€‹éŒ¯èª¤è¡¨ç¤ºé€£ç·šè¢« Broker æ‹’çµ•æˆ–é‡ç½®ã€‚æœ€å¸¸è¦‹çš„åŸå› æ˜¯ **Mosquitto MQTT Broker çš„è¨­å®šå•é¡Œ**ã€‚

---

### ğŸ“‹ è«‹åœ¨ Raspberry Pi ä¸Šæª¢æŸ¥ä»¥ä¸‹é …ç›®ï¼š

#### 1ï¸âƒ£ ç¢ºèª Mosquitto æœå‹™æ­£åœ¨é‹è¡Œ
```bash
sudo systemctl status mosquitto
```

å¦‚æœæ²’æœ‰é‹è¡Œï¼Œå•Ÿå‹•å®ƒï¼š
```bash
sudo systemctl start mosquitto
```

---

#### 2ï¸âƒ£ æª¢æŸ¥ Mosquitto è¨­å®šæª”ï¼ˆæœ€å¯èƒ½çš„åŸå› ï¼‰

Mosquitto 2.0 ä»¥å¾Œ**é è¨­ä¸å…è¨±åŒ¿åé€£ç·š**ï¼Œéœ€è¦ä¿®æ”¹è¨­å®šï¼š

```bash
sudo nano /etc/mosquitto/mosquitto.conf
```

åœ¨æª”æ¡ˆä¸­åŠ å…¥ä»¥ä¸‹å…§å®¹ï¼š
```
listener 1883 0.0.0.0
allow_anonymous true
```

å„²å­˜å¾Œé‡å•Ÿæœå‹™ï¼š
```bash
sudo systemctl restart mosquitto
```

---

#### 3ï¸âƒ£ ç¢ºèªé˜²ç«ç‰†å…è¨± 1883 ç«¯å£
```bash
sudo ufw allow 1883
```

---

#### 4ï¸âƒ£ æ¸¬è©¦ Broker æ˜¯å¦æ­£å¸¸é‹ä½œ

åœ¨ Raspberry Pi ä¸ŠåŸ·è¡Œï¼š
```bash
mosquitto_sub -h localhost -t "test" &
mosquitto_pub -h localhost -t "test" -m "hello"
```

å¦‚æœçœ‹åˆ° `hello` è¼¸å‡ºï¼Œè¡¨ç¤º Broker æ­£å¸¸ã€‚

---

### ğŸ” å¦‚æœæ‚¨çš„ Broker éœ€è¦å¸³è™Ÿå¯†ç¢¼

å¦‚æœæ‚¨æœ‰è¨­å®šèªè­‰ï¼Œè«‹å‘Šè¨´æˆ‘å¸³è™Ÿå¯†ç¢¼ï¼Œæˆ‘å¹«æ‚¨ä¿®æ”¹ç¨‹å¼ç¢¼åŠ å…¥èªè­‰ï¼š

```python
# æœ‰èªè­‰çš„é€£ç·šæ–¹å¼
client = MQTTClient(CLIENT_ID, MQTT_BROKER, port=MQTT_PORT, 
                    user="æ‚¨çš„å¸³è™Ÿ", password="æ‚¨çš„å¯†ç¢¼")
```

---

### ğŸ“ å¿«é€Ÿæª¢æŸ¥æ¸…å–®

| æª¢æŸ¥é …ç›® | æŒ‡ä»¤ |
|----------|------|
| Mosquitto æ˜¯å¦é‹è¡Œ | `sudo systemctl status mosquitto` |
| æŸ¥çœ‹ Mosquitto æ—¥èªŒ | `sudo journalctl -u mosquitto -f` |
| æª¢æŸ¥ç›£è½ç«¯å£ | `sudo netstat -tlnp \| grep 1883` |
| æ¸¬è©¦æœ¬æ©Ÿé€£ç·š | `mosquitto_pub -h localhost -t test -m hi` |

---

> ğŸ’¡ **æœ€å¸¸è¦‹è§£æ³•**ï¼šåœ¨ `/etc/mosquitto/mosquitto.conf` åŠ å…¥ `listener 1883 0.0.0.0` å’Œ `allow_anonymous true`ï¼Œç„¶å¾Œé‡å•Ÿ Mosquittoã€‚

è«‹è©¦è©¦çœ‹ï¼Œæœ‰å•é¡Œå†å‘Šè¨´æˆ‘ï¼