# MQTT 監控應用程式 - 使用說明

由於 Streamlit 與 Raspberry Pi 的相容性問題（SIGILL 錯誤），我們改用 Flask 實作。

## 問題說明

Streamlit 及其依賴套件（pandas, pyarrow）的二進制版本與您的 Raspberry Pi ARM64 架構不相容，導致程式無法運行（退出代碼 132 = SIGILL）。

## 解決方案

使用 **Flask + Socket.IO** 替代 Streamlit，提供相同的功能：
- ✅ 即時顯示電燈狀態、溫度、濕度
- ✅ 歷史數據圖表
- ✅ MQTT 訂閱
- ✅ 自動儲存到 CSV 檔案
- ✅ 美觀的網頁介面

## 使用方式

### 1. 確認 MQTT Broker 運行中

```bash
# 檢查 mosquitto 狀態
sudo systemctl status mosquitto

# 如果未運行，啟動它
sudo systemctl start mosquitto
```

### 2. 啟動 Flask 應用程式

```bash
cd /home/pi/Documents/GitHub/2025_10_26_chihlee_pi_pico/lesson6
uv run python app_flask.py
```

### 3. 開啟瀏覽器

在瀏覽器中打開以下任一網址：

- 本地：http://localhost:8080
- 網路：http://172.20.10.3:8080（從其他裝置訪問）
- 外部：http://27.247.101.93:8080（從外網訪問，需路由器設定）

### 4. 發送測試數據

在**另一個終端機**中運行：

```bash
cd /home/pi/Documents/GitHub/2025_10_26_chihlee_pi_pico/lesson6
uv run python test_mqtt_publish.py
```

這會發送 10 筆測試數據，網頁應該會即時更新。

## 檔案說明

### 主要檔案

- `app_flask.py` - Flask 應用程式主檔案（**推薦使用**）
- `templates/index.html` - 網頁介面模板
- `test_mqtt_publish.py` - MQTT 測試發布腳本
- `sensor_data.csv` - 自動儲存的數據檔案

### 已棄用（因相容性問題）

- `app.py` - Streamlit 版本（**無法運行**）
- `app_simple.py` - Streamlit 簡化版（**無法運行**）

## 功能特點

### 1. 即時數據顯示

- 電燈狀態：以圓形指示器顯示（黃色=開，灰色=關）
- 溫度：即時數值顯示（°C）
- 濕度：即時數值顯示（%）

### 2. 歷史圖表

- 雙 Y 軸折線圖
- 自動更新（每 5 秒）
- 顯示最近 100 筆數據

### 3. 數據儲存

- 自動儲存到 CSV 檔案（`sensor_data.csv`）
- 包含欄位：時間戳記、電燈狀態、溫度、濕度

### 4. WebSocket 即時推送

- 使用 Socket.IO 技術
- 收到 MQTT 訊息後立即推送到網頁
- 無需手動重新整理

## MQTT 數據格式

發送到主題 `客廳/感測器` 的訊息應為 JSON 格式：

```json
{
  "temperature": 25.5,
  "humidity": 60.0,
  "light_status": "開"
}
```

也支援其他欄位名稱：
- 溫度：`temperature`, `temp`
- 濕度：`humidity`, `humi`  
- 電燈：`light_status`, `light`

## 常見問題

### 問題 1：無法連線 MQTT

```bash
# 確認 mosquitto 運行中
sudo systemctl status mosquitto

# 測試 MQTT 連線
mosquitto_sub -h localhost -t "客廳/感測器" -v
```

### 問題 2：網頁無法開啟

確認防火牆允許 8080 埠：

```bash
sudo ufw allow 8080
```

### 問題 3：沒有數據顯示

1. 檢查終端機是否有「✅ MQTT 連線成功」訊息
2. 運行 `test_mqtt_publish.py` 發送測試數據
3. 檢查網頁的「MQTT 狀態」指示燈是否為綠色

## 效能比較

| 項目 | Streamlit | Flask |
|------|-----------|-------|
| 記憶體佔用 | ~300MB | ~50MB |
| CPU 佔用 | 高 | 低 |
| 啟動速度 | 慢（5-10秒） | 快（<1秒） |
| ARM 相容性 | ❌ 不相容 | ✅ 完全相容 |
| 即時更新 | 需重新整理 | WebSocket 推送 |

## 結論

Flask 版本在 Raspberry Pi 上：
- ✅ 完全相容
- ✅ 效能更好
- ✅ 資源佔用更少
- ✅ 即時性更強

建議使用 `app_flask.py` 作為正式版本。

