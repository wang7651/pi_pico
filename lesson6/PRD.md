# MQTT 感測器監控應用程式 - 產品需求文件 (PRD)

## 📋 專案概述

建立一個基於 Web 的 MQTT 監控應用程式，用於即時監控和視覺化感測器數據，提供直觀的數據儀表板和歷史趨勢分析。

### 版本資訊

- **版本**：1.0.0
- **最後更新**：2025-11-30
- **實作框架**：Flask + Socket.IO（替代原 Streamlit 方案）

> **技術變更說明**：因 Streamlit 與 Raspberry Pi ARM 架構相容性問題，改用 Flask 實作，提供更好的效能和穩定性。

---

## 🎯 系統角色

- **應用程式角色**：MQTT 訂閱者（Subscriber）
- **功能定位**：即時數據監控與視覺化儀表板
- **部署環境**：Raspberry Pi（ARM64 架構）

---

## 🖥️ 使用者介面需求

### 1. 頂部狀態列

- **MQTT 連線狀態**
  - 視覺化連線指示燈（綠色 = 已連線，灰色 = 未連線）
  - 顯示連線狀態文字
  
- **系統資訊**
  - 最後更新時間戳記
  - 總數據記錄數

### 2. 數據顯示區（三個資訊卡片）

#### 卡片 1：電燈狀態
- 大型圓形視覺化指示器
- 狀態：開（黃色圓形，發光效果）/ 關（灰色圓形）
- 使用圖示：🟡（開）/ ⚫（關）

#### 卡片 2：客廳溫度
- 即時溫度數值顯示
- 單位：攝氏度（°C）
- 數值格式：小數點後一位
- 圖示：🌡️

#### 卡片 3：客廳濕度
- 即時濕度數值顯示
- 單位：百分比（%）
- 數值格式：小數點後一位
- 圖示：💧

### 3. 歷史趨勢圖表

- **圖表類型**：雙 Y 軸折線圖（Line Chart）
- **左側 Y 軸**：溫度（°C）- 紅色線條
- **右側 Y 軸**：濕度（%）- 藍色線條
- **X 軸**：時間（日期 + 時間）
- **互動功能**：
  - 滑鼠懸停顯示詳細數值
  - 響應式設計，適應不同螢幕尺寸

### 4. UI/UX 設計要求

- **配色方案**：漸層紫色背景（科技感）
- **卡片設計**：白色背景，圓角，陰影效果
- **響應式布局**：支援桌面和行動裝置
- **字體**：清晰易讀的系統字體
- **動畫效果**：卡片懸停時有輕微上浮效果

---

## ⚙️ 功能需求

### 核心功能

#### 1. MQTT 數據訂閱
- **訂閱主題**：`客廳/感測器`
- **QoS 等級**：1（至少一次傳遞）
- **數據格式**：JSON
- **自動重連**：連線中斷時自動嘗試重新連線

#### 2. 即時數據顯示
- 從 MQTT Broker 接收感測器數據
- 即時更新所有 UI 元件（無需手動刷新）
- 使用 WebSocket 技術推送更新
- 僅提供顯示功能（唯讀模式）

#### 3. 數據持久化
- **儲存格式**：CSV 和 Excel (.xlsx)
- **儲存時機**：每次收到新數據時自動儲存
- **數據欄位**：
  - 時間戳記（YYYY-MM-DD HH:MM:SS）
  - 電燈狀態（開/關）
  - 溫度（數值）
  - 濕度（數值）
- **儲存位置**：應用程式根目錄
- **檔案命名**：
  - `sensor_data.csv`（應用程式使用）
  - `sensor_data.xlsx`（人工查看）

#### 4. 歷史數據管理
- 保留最近 100 筆數據於記憶體
- 啟動時自動載入現有歷史數據
- 數據超過限制時，移除最舊的記錄

---

## 🔧 技術規格

### 後端技術

- **Web 框架**：Flask 3.1+
- **即時通訊**：Flask-SocketIO 5.5+
- **MQTT 客戶端**：paho-mqtt 2.1+
- **數據處理**：CSV（標準庫）
- **Excel 處理**：openpyxl 3.1+

### 前端技術

- **基礎技術**：HTML5 + CSS3 + JavaScript（ES6+）
- **圖表庫**：Chart.js 4.5+
- **即時通訊**：Socket.IO Client 4.5+
- **UI 框架**：原生 CSS（漸層、Flexbox、Grid）

### 通訊協定

- **MQTT 協定**：MQTT 3.1.1
- **Broker**：Mosquitto
- **預設埠號**：1883
- **WebSocket**：Socket.IO over HTTP

### 數據格式定義

#### MQTT 訊息格式（JSON）

```json
{
  "temperature": 25.5,
  "humidity": 60.0,
  "light_status": "開"
}
```

**欄位說明**：
- `temperature` 或 `temp`：溫度（浮點數）
- `humidity` 或 `humi`：濕度（浮點數）
- `light_status` 或 `light`：電燈狀態（字串："開"/"關"）

### 效能要求

- **啟動時間**：< 2 秒
- **記憶體佔用**：< 100 MB
- **CPU 使用率**：閒置時 < 5%
- **數據更新延遲**：< 500 ms
- **同時支援連線數**：10 個瀏覽器

---

## 🚀 部署需求

### 系統環境

- **作業系統**：Raspberry Pi OS（Debian-based）
- **Python 版本**：3.10+
- **套件管理器**：uv
- **MQTT Broker**：Mosquitto

### 網路需求

- **應用程式埠號**：8080
- **MQTT Broker 埠號**：1883
- **防火牆設定**：允許埠號 8080 和 1883

### 檔案結構

```
lesson6/
├── app_flask.py              # 主應用程式
├── templates/
│   └── index.html            # 網頁模板
├── sensor_data.csv           # CSV 數據
├── sensor_data.xlsx          # Excel 數據
├── start.sh                  # 啟動腳本
└── README.md                 # 說明文件
```

---

## 📊 測試需求

### 功能測試

1. **MQTT 連線測試**
   - 正常連線情境
   - 斷線重連情境
   - Broker 未啟動情境

2. **數據接收測試**
   - 正常 JSON 數據
   - 不完整數據處理
   - 非 JSON 格式處理

3. **UI 更新測試**
   - 即時更新驗證
   - 多筆數據連續接收
   - 圖表正確渲染

4. **數據儲存測試**
   - CSV 檔案正確寫入
   - Excel 檔案正確寫入
   - 檔案權限驗證

### 效能測試

- 連續接收 100 筆數據無延遲
- 記憶體不會持續增長
- 長時間運行（24 小時）穩定性

---

## 🔮 未來擴充建議

### 第一階段（已完成）
- ✅ 即時數據顯示
- ✅ 歷史趨勢圖表
- ✅ 數據持久化（CSV + Excel）
- ✅ WebSocket 即時更新

### 第二階段（可選）
- 數據篩選與查詢功能
- 自訂時間範圍查詢
- 數據匯出功能（PDF、圖片）
- 異常值警報通知

### 第三階段（進階）
- 多房間監控支援
- 使用者認證與權限管理
- 歷史數據回放功能
- 行動 APP（React Native）

### 第四階段（AI/ML）
- 溫濕度預測分析
- 異常模式偵測
- 智慧化控制建議
- 數據統計報表生成

---

## 📝 附註

### 技術決策說明

**為何選擇 Flask 而非 Streamlit？**

1. **相容性**：Streamlit 在 Raspberry Pi ARM64 架構上有相容性問題（SIGILL 錯誤）
2. **效能**：Flask 記憶體佔用少（~50MB vs ~300MB），啟動快速（<1s vs 5-10s）
3. **靈活性**：Flask 提供更多自訂空間，WebSocket 整合更容易
4. **穩定性**：經過充分測試，在 Raspberry Pi 上運行穩定

### 已知限制

- 目前僅支援單一 MQTT 主題訂閱
- 歷史數據僅保留最近 100 筆於記憶體
- 無使用者認證機制（適用於內網環境）
- 圖表互動功能有限（基於 Chart.js）

### 版本歷史

- **v1.0.0**（2025-11-30）：初版發布，使用 Flask 實作
- ~~v0.1.0（計劃中）：Streamlit 版本（因相容性問題取消）~~